<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f7fafc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th,
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
      vertical-align: middle;
      font-size: 0.9rem;
      white-space: normal;
      word-break: break-word;
      overflow: hidden;
    }

    th {
      background: #f1f5f9;
      cursor: pointer;
      user-select: none;
      font-weight: 700;
    }

    tr:hover {
      background: #f9fafb;
    }

    label {
      cursor: pointer;
    }

    /* ===== Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª (Tooltips) ===== */
    td[title] {
      position: relative;
    }

    td[title]:hover::after {
      content: attr(title);
      position: absolute;
      right: 50%;
      bottom: 100%;
      transform: translateX(50%) translateY(-4px);
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 5px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 10;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #f1f5f9;
      z-index: 5;
    }

    /* ===== Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ===== */
    #employeeModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      z-index: 50;
    }

    #employeeModal.active {
      display: flex;
    }
  </style>
</head>

<body class="p-6">
  <header class="mb-8 text-center">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Ù„ÙˆØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
    <p class="text-gray-600">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø£ÙŠ Ø¹Ù…ÙˆØ¯ Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.</p>
  </header>

  <div class="max-w-7xl mx-auto space-y-6">
    <div>
      <label for="manager-filter" class="block text-sm font-medium text-gray-700 mb-2">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±:</label>
      <select id="manager-filter"
        class="w-full md:w-64 p-3 border border-gray-300 rounded-md bg-white shadow-sm focus:ring-2 focus:ring-indigo-500">
        <option value="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
      </select>
    </div>

    <div>
      <h3 class="text-lg font-bold text-indigo-800 mb-3">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</h3>
      <div id="role-checkboxes" class="flex flex-wrap gap-4">
        <label class="flex items-center gap-2"><input type="checkbox" value="Ø¹Ø§Ù…Ù„ ØªØ­Ù…ÙŠÙ„ Ùˆ ØªÙ†Ø²ÙŠÙ„" /> Ø¹Ø§Ù…Ù„ ØªØ­Ù…ÙŠÙ„ Ùˆ
          ØªÙ†Ø²ÙŠÙ„</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="Ù…Ø´Ø±Ù Ù…Ø¹Ø§Ø±Ø¶" /> Ù…Ø´Ø±Ù Ù…Ø¹Ø§Ø±Ø¶</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="Ù…Ø¯ÙŠØ± Ù…Ø¹Ø±Ø¶" /> Ù…Ø¯ÙŠØ± Ù…Ø¹Ø±Ø¶</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="Ø¨Ø§Ø¦Ø¹" /> Ø¨Ø§Ø¦Ø¹</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="Ù†Ø§Ø¦Ø¨ Ù…Ø¯ÙŠØ± Ù…Ø¹Ø±Ø¶" /> Ù†Ø§Ø¦Ø¨ Ù…Ø¯ÙŠØ± Ù…Ø¹Ø±Ø¶</label>
      </div>
    </div>

    <div id="dashboard-container" class="space-y-10"></div>
  </div>

  <!-- ğŸ”¹ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
  <div id="employeeModal">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-2xl relative">
      <button id="closeModal" class="absolute top-2 left-3 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      <h2 id="modalName" class="text-2xl font-bold text-indigo-800 mb-4"></h2>
      <div id="modalContent" class="text-gray-700 space-y-3 text-sm"></div>
    </div>
  </div>

  <script>
    const managerFilter = document.getElementById('manager-filter');
    const roleContainer = document.getElementById('role-checkboxes');
    const container = document.getElementById('dashboard-container');
    const modal = document.getElementById('employeeModal');
    const modalName = document.getElementById('modalName');
    const modalContent = document.getElementById('modalContent');
    const closeModal = document.getElementById('closeModal');

    closeModal.addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });

    async function initializeDashboard() {
      try {
        const response = await fetch('data.json');
        if (!response.ok) throw new Error('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ data.json');
        const data = await response.json();
        renderDashboard(data.employees_by_store, data.managers);
      } catch (err) {
        container.innerHTML = `<p class='text-center text-red-600 font-bold'>${err.message}</p>`;
      }
    }

    function renderDashboard(employeesByStore, managers) {
      const allManagers = Object.keys(managers);
      allManagers.forEach(manager => {
        const opt = document.createElement('option');
        opt.value = manager;
        opt.textContent = manager;
        managerFilter.appendChild(opt);
      });

      const updateView = () => {
        const selectedManager = managerFilter.value;
        const selectedRoles = getSelectedRoles();
        displayManagerSections(employeesByStore, managers, selectedManager, selectedRoles);
      };

      managerFilter.addEventListener('change', updateView);
      roleContainer.addEventListener('change', updateView);
      displayManagerSections(employeesByStore, managers);
    }

    function getSelectedRoles() {
      return Array.from(roleContainer.querySelectorAll('input:checked')).map(ch => ch.value);
    }

    function displayManagerSections(employeesByStore, managers, selectedManager = 'all', selectedRoles = []) {
      container.innerHTML = '';

      // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒÙ„ Ù…Ø¹Ø±Ø¶ (Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±Ø©)
      const outletTotals = {};
      for (const [_, storeData] of Object.entries(employeesByStore)) {
        storeData.employees.forEach(emp => {
          const sales = (emp.monthly_sales || []).reduce((a, b) => a + (parseFloat(b) || 0), 0);
          if (!outletTotals[emp.outlet]) outletTotals[emp.outlet] = 0;
          outletTotals[emp.outlet] += sales;
        });
      }

      let allEmployees = [];
      for (const [_, storeData] of Object.entries(employeesByStore)) {
        storeData.employees.forEach(emp => {
          if (selectedRoles.length > 0 && !selectedRoles.includes(emp.title)) return;
          if (selectedManager !== 'all' && emp.manager !== selectedManager) return;

          const calculatedTotalSales = (emp.monthly_sales || []).reduce((a, b) => a + (parseFloat(b) || 0), 0);
          const { avg, monthsWorked, fromMonth, toMonth } = calculateAvgSales(calculatedTotalSales, emp.join_date);
          const tooltip = `ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ${monthsWorked} Ø´Ù‡Ø± (${fromMonth} - ${toMonth})`;

          // Store calculated values
          allEmployees.push({
            ...emp,
            avg,
            monthsWorked,
            tooltip,
            calculatedTotalSales
          });
        });
      }

      if (!allEmployees.length) {
        container.innerHTML = `<p class='text-center text-gray-500 mt-8'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</p>`;
        return;
      }

      let rows = allEmployees.map(emp => {
        const joinDate = new Date(emp.join_date);

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
        const monthlyComms = (emp.monthly_commissions || []).map(v => parseFloat(v) || 0);
        const calculatedTotalCommission = monthlyComms.reduce((a, b) => a + b, 0);
        const commissionMonths = monthlyComms.filter(v => v > 0).length || 1;

        const avgCommission = calculatedTotalCommission / commissionMonths;
        // const avgIncome = (parseFloat(emp.salary) || 0) + avgCommission;
        const avgIncome = ((parseFloat(emp.salary) || 0) * emp.monthsWorked + calculatedTotalCommission) / emp.monthsWorked;

        const outletTotal = outletTotals[emp.outlet] || 1;
        // Use calculated total sales
        const sharePct = (emp.calculatedTotalSales / outletTotal) * 100;

        return `
          <tr>
            <td class='text-indigo-700 font-semibold cursor-pointer hover:underline' onclick='showDetails(${JSON.stringify(emp).replace(/'/g, "&#39;")})' title="Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù">${emp.name}</td>
            <td>${emp.outlet}</td>
            <td title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù">${formatNumber(emp.calculatedTotalSales)}</td>
            <td title="Ù†Ø³Ø¨Ø© Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¶">${sharePct.toFixed(1)}%</td>
            <td title="${emp.tooltip}">${formatNumber(emp.avg)}</td>
            <td title="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ${emp.join_date}">${emp.years_of_service}</td>
            <td title="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª">${formatNumber(emp.salary)}</td>
            <td title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª (Ù…Ø­Ø³ÙˆØ¨Ø© Ù…Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±)">${formatNumber(calculatedTotalCommission)}</td>
            <td title="((Ø§Ù„Ø±Ø§ØªØ¨ Ã— ${emp.monthsWorked}) + Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª) / ${emp.monthsWorked}">${formatNumber(avgIncome)}</td>
          </tr>`;
      }).join('');

      container.innerHTML = `
        <div class='bg-white shadow-md rounded-lg p-4'>
          <div class='flex justify-between items-center mb-3'>
            <h3 class='text-lg font-bold text-gray-800'>
              ${selectedManager === "all" ? "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†" : selectedManager}
            </h3>
            <span class='text-gray-500 text-sm'>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${allEmployees.length}</span>
          </div>
          <div class='overflow-x-auto'>
            <table class='w-full text-sm text-gray-700 text-center'>
              <thead>
                <tr>
                  <th data-key='name'>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th data-key='outlet'>Ø§Ù„Ù…Ø¹Ø±Ø¶</th>
                  <th data-key='total_sales'>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                  <th data-key='sales_share'>Ø­ØµØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶ (%)</th>
                  <th data-key='avg_sales'>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</th>
                  <th data-key='years_of_service'>Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                  <th data-key='salary'>Ø§Ù„Ø±Ø§ØªØ¨</th>
                  <th data-key='commissions'>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</th>
                  <th data-key='average_income'>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>`;

      // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ø¹Ù…ÙˆØ¯
      document.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.key;
          const table = th.closest('table');
          sortTable(table, key);
        });
      });
    }

    function showDetails(emp) {
      modal.classList.add('active');
      modalName.textContent = emp.name;
      const sales = emp.monthly_sales || [];
      const comms = emp.monthly_commissions || [];
      let salesRows = sales.map((v, i) => `<tr><td>Ø§Ù„Ø´Ù‡Ø± ${i + 1}</td><td>${formatNumber(v)}</td><td>${formatNumber(comms[i] || 0)}</td></tr>`).join('');

      const monthlyComms = (emp.monthly_commissions || []).map(v => parseFloat(v) || 0);
      const totalCommCalc = monthlyComms.reduce((a, b) => a + b, 0);

      const monthlySales = (emp.monthly_sales || []).map(v => parseFloat(v) || 0);
      const totalSalesCalc = monthlySales.reduce((a, b) => a + b, 0);

      modalContent.innerHTML = `
        <p><strong>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</strong> ${emp.title}</p>
        <p><strong>Ø§Ù„Ù…Ø¹Ø±Ø¶:</strong> ${emp.outlet}</p>
        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</strong> ${emp.join_date}</p>
        <p><strong>Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø©:</strong> ${emp.years_of_service}</p>
        <p><strong>Ø§Ù„Ø±Ø§ØªØ¨:</strong> ${formatNumber(emp.salary)}</p>
        <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª:</strong> ${formatNumber(totalCommCalc)}</p>
        <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</strong> ${formatNumber(totalSalesCalc)}</p>
        <hr class='my-3'>
        <p class='font-bold text-indigo-700 mb-2'>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±:</p>
        <table class='w-full text-sm border'>
          <thead class='bg-gray-100'>
            <tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th><th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</th></tr>
          </thead>
          <tbody>${salesRows}</tbody>
        </table>
      `;
    }

    function sortTable(table, key) {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const headerIndex = Array.from(table.querySelectorAll('th')).findIndex(th => th.dataset.key === key);
      const isNumeric = ['total_sales', 'avg_sales', 'salary', 'commissions', 'average_income', 'sales_share'].includes(key);

      let direction = table.dataset.sorted === key && table.dataset.direction === 'asc' ? 'desc' : 'asc';
      table.dataset.sorted = key;
      table.dataset.direction = direction;

      rows.sort((a, b) => {
        const valA = a.children[headerIndex].textContent.trim().replace('%', '');
        const valB = b.children[headerIndex].textContent.trim().replace('%', '');

        let numA, numB;

        if (key === 'years_of_service') {
          const parseYearsMonths = (val) => {
            const cleaned = val.replace(/[^\d\s]/g, ' ');
            const parts = cleaned.trim().split(/\s+/).map(Number).filter(n => !isNaN(n));
            const years = parts[0] || 0;
            const months = parts[1] || 0;
            return years * 12 + months;
          };
          numA = parseYearsMonths(valA);
          numB = parseYearsMonths(valB);
        }
        else if (isNumeric) {
          numA = parseFloat(valA.replace(/,/g, '')) || 0;
          numB = parseFloat(valB.replace(/,/g, '')) || 0;
        }
        else {
          return direction === 'asc' ? valA.localeCompare(valB, 'ar') : valB.localeCompare(valA, 'ar');
        }

        return direction === 'asc' ? numA - numB : numB - numA;
      });

      tbody.innerHTML = '';
      rows.forEach(r => tbody.appendChild(r));
    }

    function calculateAvgSales(totalSales, joinDateStr) {
      if (totalSales === null || totalSales === undefined) return { avg: 0, monthsWorked: 0, fromMonth: "-", toMonth: "-" };
      const joinDate = new Date(joinDateStr);
      const startOfYear = new Date('2025-01-01');
      const endOfData = new Date('2025-11-30');
      let effectiveStart = joinDate > startOfYear ? joinDate : startOfYear;

      let monthsWorked = (endOfData.getFullYear() - effectiveStart.getFullYear()) * 12 + (endOfData.getMonth() - effectiveStart.getMonth()) + 1;
      if (monthsWorked < 1) monthsWorked = 1;
      if (monthsWorked > 11) monthsWorked = 11;

      const fromMonth = effectiveStart.toLocaleString('en-US', { month: 'long' });
      const toMonth = endOfData.toLocaleString('en-US', { month: 'long' });

      return { avg: totalSales / monthsWorked, monthsWorked, fromMonth, toMonth };
    }

    function formatNumber(num) {
      const n = parseFloat(num) || 0;
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);
    }

    document.addEventListener('DOMContentLoaded', initializeDashboard);
  </script>
</body>

</html>