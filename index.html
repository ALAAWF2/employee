<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>لوحة بيانات الموظفين</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f7fafc; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
      vertical-align: middle;
      font-size: 0.9rem;
      white-space: normal;
      word-break: break-word;
      overflow: hidden;
    }
    th { background: #f1f5f9; cursor: pointer; user-select: none; font-weight: 700; }
    tr:hover { background: #f9fafb; }
    label { cursor: pointer; }

    /* ===== التلميحات (Tooltips) ===== */
    td[title] { position: relative; }
    td[title]:hover::after {
      content: attr(title);
      position: absolute;
      right: 50%;
      bottom: 100%;
      transform: translateX(50%) translateY(-4px);
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 5px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 10;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #f1f5f9;
      z-index: 5;
    }

    /* ===== النافذة المنبثقة ===== */
    #employeeModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      z-index: 50;
    }
    #employeeModal.active { display: flex; }
  </style>
</head>
<body class="p-6">
  <header class="mb-8 text-center">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">لوحة بيانات الموظفين</h1>
    <p class="text-gray-600">اضغط على اسم أي عمود لترتيب البيانات أو على اسم الموظف لعرض التفاصيل.</p>
  </header>

  <div class="max-w-7xl mx-auto space-y-6">
    <div>
      <label for="manager-filter" class="block text-sm font-medium text-gray-700 mb-2">تصفية حسب المدير:</label>
      <select id="manager-filter" class="w-full md:w-64 p-3 border border-gray-300 rounded-md bg-white shadow-sm focus:ring-2 focus:ring-indigo-500">
        <option value="all">عرض الكل</option>
      </select>
    </div>

    <div>
      <h3 class="text-lg font-bold text-indigo-800 mb-3">تصفية حسب المسمى الوظيفي:</h3>
      <div id="role-checkboxes" class="flex flex-wrap gap-4">
        <label class="flex items-center gap-2"><input type="checkbox" value="عامل تحميل و تنزيل" /> عامل تحميل و تنزيل</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="مشرف معارض" /> مشرف معارض</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="مدير معرض" /> مدير معرض</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="بائع" /> بائع</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="نائب مدير معرض" /> نائب مدير معرض</label>
      </div>
    </div>

    <div id="dashboard-container" class="space-y-10"></div>
  </div>

  <!-- 🔹 نافذة التفاصيل -->
  <div id="employeeModal">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-2xl relative">
      <button id="closeModal" class="absolute top-2 left-3 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      <h2 id="modalName" class="text-2xl font-bold text-indigo-800 mb-4"></h2>
      <div id="modalContent" class="text-gray-700 space-y-3 text-sm"></div>
    </div>
  </div>

  <script>
    const managerFilter = document.getElementById('manager-filter');
    const roleContainer = document.getElementById('role-checkboxes');
    const container = document.getElementById('dashboard-container');
    const modal = document.getElementById('employeeModal');
    const modalName = document.getElementById('modalName');
    const modalContent = document.getElementById('modalContent');
    const closeModal = document.getElementById('closeModal');

    closeModal.addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });

    async function initializeDashboard() {
      try {
        const response = await fetch('data.json');
        if (!response.ok) throw new Error('تعذر تحميل data.json');
        const data = await response.json();
        renderDashboard(data.employees_by_store, data.managers);
      } catch (err) {
        container.innerHTML = `<p class='text-center text-red-600 font-bold'>${err.message}</p>`;
      }
    }

    function renderDashboard(employeesByStore, managers) {
      const allManagers = Object.keys(managers);
      allManagers.forEach(manager => {
        const opt = document.createElement('option');
        opt.value = manager;
        opt.textContent = manager;
        managerFilter.appendChild(opt);
      });

      const updateView = () => {
        const selectedManager = managerFilter.value;
        const selectedRoles = getSelectedRoles();
        displayManagerSections(employeesByStore, managers, selectedManager, selectedRoles);
      };

      managerFilter.addEventListener('change', updateView);
      roleContainer.addEventListener('change', updateView);
      displayManagerSections(employeesByStore, managers);
    }

    function getSelectedRoles() {
      return Array.from(roleContainer.querySelectorAll('input:checked')).map(ch => ch.value);
    }

    function displayManagerSections(employeesByStore, managers, selectedManager='all', selectedRoles=[]) {
      container.innerHTML = '';

      // إجمالي مبيعات كل معرض (بدون فلترة)
      const outletTotals = {};
      for (const [_, storeData] of Object.entries(employeesByStore)) {
        storeData.employees.forEach(emp => {
          const sales = parseFloat(emp.total_sales) || 0;
          if (!outletTotals[emp.outlet]) outletTotals[emp.outlet] = 0;
          outletTotals[emp.outlet] += sales;
        });
      }

      let allEmployees = [];
      for (const [_, storeData] of Object.entries(employeesByStore)) {
        storeData.employees.forEach(emp => {
          if (selectedRoles.length > 0 && !selectedRoles.includes(emp.title)) return;
          if (selectedManager !== 'all' && emp.manager !== selectedManager) return;
          const { avg, monthsWorked, fromMonth, toMonth } = calculateAvgSales(emp.total_sales, emp.join_date);
          const tooltip = `تم حساب المتوسط بناءً على ${monthsWorked} شهر (${fromMonth} - ${toMonth})`;
          allEmployees.push({ ...emp, avg, monthsWorked, tooltip });
        });
      }

      if (!allEmployees.length) {
        container.innerHTML = `<p class='text-center text-gray-500 mt-8'>لا توجد بيانات مطابقة</p>`;
        return;
      }

      let rows = allEmployees.map(emp => {
        const joinDate = new Date(emp.join_date);
        let monthsForCalc = joinDate < new Date('2025-01-01') ? 9 : emp.monthsWorked;
        if (!monthsForCalc || monthsForCalc < 1) monthsForCalc = 1;

        const avgCommission = emp.total_commission ? emp.total_commission / monthsForCalc : 0;
        const avgIncome = (parseFloat(emp.salary) || 0) + avgCommission;

        const outletTotal = outletTotals[emp.outlet] || 1;
        const sharePct = (emp.total_sales / outletTotal) * 100;

        return `
          <tr>
            <td class='text-indigo-700 font-semibold cursor-pointer hover:underline' onclick='showDetails(${JSON.stringify(emp)})' title="اضغط لعرض تفاصيل الموظف">${emp.name}</td>
            <td>${emp.outlet}</td>
            <td title="إجمالي مبيعات الموظف">${formatNumber(emp.total_sales)}</td>
            <td title="نسبة مساهمة الموظف في مبيعات المعرض">${sharePct.toFixed(1)}%</td>
            <td title="${emp.tooltip}">${formatNumber(emp.avg)}</td>
            <td title="تاريخ الانضمام: ${emp.join_date}">${emp.years_of_service}</td>
            <td title="الراتب الشهري الثابت">${formatNumber(emp.salary)}</td>
            <td title="إجمالي العمولات">${formatNumber(emp.total_commission)}</td>
            <td title="الراتب + (العمولات ÷ ${monthsForCalc})">${formatNumber(avgIncome)}</td>
          </tr>`;
      }).join('');

      container.innerHTML = `
        <div class='bg-white shadow-md rounded-lg p-4'>
          <div class='flex justify-between items-center mb-3'>
            <h3 class='text-lg font-bold text-gray-800'>
              ${selectedManager === "all" ? "جميع الموظفين" : selectedManager}
            </h3>
            <span class='text-gray-500 text-sm'>عدد الموظفين: ${allEmployees.length}</span>
          </div>
          <div class='overflow-x-auto'>
            <table class='w-full text-sm text-gray-700 text-center'>
              <thead>
                <tr>
                  <th data-key='name'>اسم الموظف</th>
                  <th data-key='outlet'>المعرض</th>
                  <th data-key='total_sales'>المبيعات</th>
                  <th data-key='sales_share'>حصة المبيعات من المعرض (%)</th>
                  <th data-key='avg_sales'>متوسط المبيعات الشهرية</th>
                  <th data-key='years_of_service'>سنوات الخدمة</th>
                  <th data-key='salary'>الراتب</th>
                  <th data-key='commissions'>العمولات</th>
                  <th data-key='average_income'>متوسط الدخل الشهري</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>`;

      // تفعيل الترتيب عند الضغط على رأس العمود
      document.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.key;
          const table = th.closest('table');
          sortTable(table, key);
        });
      });
    }

    function showDetails(emp) {
      modal.classList.add('active');
      modalName.textContent = emp.name;
      const sales = emp.monthly_sales || [];
      const comms = emp.monthly_commissions || [];
      let salesRows = sales.map((v,i)=> `<tr><td>الشهر ${i+1}</td><td>${formatNumber(v)}</td><td>${formatNumber(comms[i]||0)}</td></tr>`).join('');
      modalContent.innerHTML = `
        <p><strong>المسمى الوظيفي:</strong> ${emp.title}</p>
        <p><strong>المعرض:</strong> ${emp.outlet}</p>
        <p><strong>تاريخ الانضمام:</strong> ${emp.join_date}</p>
        <p><strong>سنوات الخدمة:</strong> ${emp.years_of_service}</p>
        <p><strong>الراتب:</strong> ${formatNumber(emp.salary)}</p>
        <p><strong>إجمالي العمولات:</strong> ${formatNumber(emp.total_commission)}</p>
        <p><strong>إجمالي المبيعات:</strong> ${formatNumber(emp.total_sales)}</p>
        <hr class='my-3'>
        <p class='font-bold text-indigo-700 mb-2'>تفاصيل الأشهر:</p>
        <table class='w-full text-sm border'>
          <thead class='bg-gray-100'>
            <tr><th>الشهر</th><th>المبيعات</th><th>العمولات</th></tr>
          </thead>
          <tbody>${salesRows}</tbody>
        </table>
      `;
    }

    function sortTable(table, key) {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const headerIndex = Array.from(table.querySelectorAll('th')).findIndex(th => th.dataset.key === key);
      const isNumeric = ['total_sales', 'avg_sales', 'salary', 'commissions', 'average_income', 'sales_share'].includes(key);

      let direction = table.dataset.sorted === key && table.dataset.direction === 'asc' ? 'desc' : 'asc';
      table.dataset.sorted = key;
      table.dataset.direction = direction;

      rows.sort((a, b) => {
        const valA = a.children[headerIndex].textContent.trim().replace('%','');
        const valB = b.children[headerIndex].textContent.trim().replace('%','');

        let numA, numB;

        if (key === 'years_of_service') {
          const parseYearsMonths = (val) => {
            const cleaned = val.replace(/[^\d\s]/g, ' ');
            const parts = cleaned.trim().split(/\s+/).map(Number).filter(n => !isNaN(n));
            const years = parts[0] || 0;
            const months = parts[1] || 0;
            return years * 12 + months;
          };
          numA = parseYearsMonths(valA);
          numB = parseYearsMonths(valB);
        } 
        else if (isNumeric) {
          numA = parseFloat(valA.replace(/,/g, '')) || 0;
          numB = parseFloat(valB.replace(/,/g, '')) || 0;
        } 
        else {
          return direction === 'asc' ? valA.localeCompare(valB, 'ar') : valB.localeCompare(valA, 'ar');
        }

        return direction === 'asc' ? numA - numB : numB - numA;
      });

      tbody.innerHTML = '';
      rows.forEach(r => tbody.appendChild(r));
    }

    function calculateAvgSales(totalSales, joinDateStr) {
      if (!totalSales) return { avg: 0, monthsWorked: 0, fromMonth: "-", toMonth: "-" };
      const joinDate = new Date(joinDateStr);
      const startOfYear = new Date('2025-01-01');
      const endOfData = new Date('2025-09-30');
      let effectiveStart = joinDate > startOfYear ? joinDate : startOfYear;

      let monthsWorked = (endOfData.getFullYear() - effectiveStart.getFullYear()) * 12 + (endOfData.getMonth() - effectiveStart.getMonth()) + 1;
      if (monthsWorked < 1) monthsWorked = 1;
      if (monthsWorked > 9) monthsWorked = 9;

      const fromMonth = effectiveStart.toLocaleString('en-US', { month: 'long' });
      const toMonth = endOfData.toLocaleString('en-US', { month: 'long' });

      return { avg: totalSales / monthsWorked, monthsWorked, fromMonth, toMonth };
    }

    function formatNumber(num) {
      const n = parseFloat(num) || 0;
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);
    }

    document.addEventListener('DOMContentLoaded', initializeDashboard);
  </script>
</body>
</html>
