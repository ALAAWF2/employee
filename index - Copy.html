<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family:'Cairo',sans-serif; background:#f7fafc; }
    table { table-layout:auto; width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #e5e7eb; text-align:right; white-space:nowrap; }
    th { background:#f1f5f9; cursor:pointer; user-select:none; }
    tr:hover { background:#f9fafb; }
    label { cursor:pointer; }
    td[title] {
      position: relative;
    }
    td[title]:hover::after {
      content: attr(title);
      position: absolute;
      right: 0;
      bottom: 100%;
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 5px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      transform: translateY(-4px);
    }
  </style>
</head>
<body class="p-6">
  <header class="mb-8 text-center">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Ù„ÙˆØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
    <p class="text-gray-600">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø£ÙŠ Ø¹Ù…ÙˆØ¯ Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨Ù‡.</p>
  </header>

  <div class="max-w-7xl mx-auto space-y-6">

    <!-- ğŸ”¹ ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø¯ÙŠØ± -->
    <div>
      <label for="manager-filter" class="block text-sm font-medium text-gray-700 mb-2">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±:</label>
      <select id="manager-filter" class="w-full md:w-64 p-3 border border-gray-300 rounded-md bg-white shadow-sm focus:ring-2 focus:ring-indigo-500">
        <option value="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
      </select>
    </div>

    <!-- ğŸ”¹ ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ -->
    <div>
      <h3 class="text-lg font-bold text-indigo-800 mb-3">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</h3>
      <div id="role-checkboxes" class="flex flex-wrap gap-4">
        <label class="flex items-center gap-2"><input type="checkbox" value="Ø¹Ø§Ù…Ù„ ØªØ­Ù…ÙŠÙ„ Ùˆ ØªÙ†Ø²ÙŠÙ„" /> Ø¹Ø§Ù…Ù„ ØªØ­Ù…ÙŠÙ„ Ùˆ ØªÙ†Ø²ÙŠÙ„</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="Ù…Ø´Ø±Ù Ù…Ø¹Ø§Ø±Ø¶" /> Ù…Ø´Ø±Ù Ù…Ø¹Ø§Ø±Ø¶</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="Ù…Ø¯ÙŠØ± Ù…Ø¹Ø±Ø¶" /> Ù…Ø¯ÙŠØ± Ù…Ø¹Ø±Ø¶</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="Ø¨Ø§Ø¦Ø¹" /> Ø¨Ø§Ø¦Ø¹</label>
        <label class="flex items-center gap-2"><input type="checkbox" value="Ù†Ø§Ø¦Ø¨ Ù…Ø¯ÙŠØ± Ù…Ø¹Ø±Ø¶" /> Ù†Ø§Ø¦Ø¨ Ù…Ø¯ÙŠØ± Ù…Ø¹Ø±Ø¶</label>
      </div>
    </div>

    <div id="dashboard-container" class="space-y-10"></div>
  </div>

  <script>
    const managerFilter = document.getElementById('manager-filter');
    const roleContainer = document.getElementById('role-checkboxes');
    const container = document.getElementById('dashboard-container');

    async function initializeDashboard() {
      try {
        const response = await fetch('data.json');
        if (!response.ok) throw new Error('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ data.json');
        const data = await response.json();
        renderDashboard(data.employees_by_store, data.managers);
      } catch (err) {
        container.innerHTML = `<p class='text-center text-red-600 font-bold'>${err.message}</p>`;
      }
    }

    function renderDashboard(employeesByStore, managers) {
      const allManagers = Object.keys(managers);
      allManagers.forEach(manager => {
        const opt = document.createElement('option');
        opt.value = manager;
        opt.textContent = manager;
        managerFilter.appendChild(opt);
      });

      managerFilter.addEventListener('change', () => {
        const selectedManager = managerFilter.value;
        const selectedRoles = getSelectedRoles();
        displayManagerSections(employeesByStore, managers, selectedManager, selectedRoles);
      });

      roleContainer.addEventListener('change', () => {
        const selectedManager = managerFilter.value;
        const selectedRoles = getSelectedRoles();
        displayManagerSections(employeesByStore, managers, selectedManager, selectedRoles);
      });

      displayManagerSections(employeesByStore, managers);
    }

    function getSelectedRoles() {
      return Array.from(roleContainer.querySelectorAll('input:checked')).map(ch => ch.value);
    }

   function displayManagerSections(employeesByStore, managers, selectedManager='all', selectedRoles=[]) {
  container.innerHTML = '';

  // ğŸ”¹ Ø­Ø§Ù„Ø© "Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„": Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ­Ù‘Ø¯
  if (selectedManager === 'all') {
    let allEmployees = [];

    // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ù† ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶
    for (const [_, storeData] of Object.entries(employeesByStore)) {
      storeData.employees.forEach(emp => {
        if (selectedRoles.length > 0 && !selectedRoles.includes(emp.title)) return;
        const { avg, monthsWorked, fromMonth, toMonth } = calculateAvgSales(emp.total_sales, emp.join_date);
        const tooltip = `Calculated based on ${monthsWorked} months (from ${fromMonth} to ${toMonth})`;
        allEmployees.push({
          ...emp,
          avg,
          tooltip
        });
      });
    }

    // ØªÙˆÙ„ÙŠØ¯ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯
    let rows = allEmployees.map(emp => `
      <tr>
        <td>${emp.name}</td>
        <td>${emp.join_date}</td>
        <td>${emp.outlet}</td>
        <td>${formatNumber(emp.total_sales)}</td>
        <td title="${emp.tooltip}">${formatNumber(emp.avg)}</td>
        <td>${formatNumber(emp.salary)}</td>
        <td>${emp.years_of_service}</td>
        <td>${formatNumber(emp.commissions)}</td>
        <td>${formatNumber(emp.average_income)}</td>
      </tr>`).join('');

    if (!rows.trim()) {
      container.innerHTML = `<p class='text-center text-gray-500 mt-8'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</p>`;
      return;
    }

    // Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ­Ø¯
    container.innerHTML = `
      <div class='bg-white shadow-md rounded-lg p-4'>
        <div class='flex justify-between items-center mb-3'>
          <h3 class='text-lg font-bold text-gray-800'>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
        </div>
        <div class='overflow-x-auto'>
          <table class='w-full text-sm text-gray-700'>
            <thead>
              <tr>
                <th data-key='name'>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th data-key='join_date'>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th>
                <th data-key='outlet'>Ø§Ù„Ù…Ø¹Ø±Ø¶</th>
                <th data-key='total_sales'>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                <th data-key='avg_sales'>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</th>
                <th data-key='salary'>Ø§Ù„Ø±Ø§ØªØ¨</th>
                <th data-key='years_of_service'>Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                <th data-key='commissions'>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</th>
                <th data-key='average_income'>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>`;

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙØ±Ø² Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯
    document.querySelectorAll('th').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        const table = th.closest('table');
        sortTable(table, key);
      });
    });
    return;
  }

  // ğŸ”¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ù…Ø¹Ø§Ø±Ø¶
  for (const [manager, outlets] of Object.entries(managers)) {
    if (selectedManager !== 'all' && manager !== selectedManager) continue;

    let managerHTML = `<h2 class='text-2xl font-bold text-indigo-700 mb-4 border-b-2 border-indigo-200 pb-2'>${manager}</h2>`;

    outlets.forEach(outletName => {
      const norm = normalizeName(outletName);
      const storeData = employeesByStore[norm];
      if (!storeData || !storeData.employees.length) return;

      let rows = '';
      storeData.employees.forEach(emp => {
        if (selectedRoles.length > 0 && !selectedRoles.includes(emp.title)) return;
        const { avg, monthsWorked, fromMonth, toMonth } = calculateAvgSales(emp.total_sales, emp.join_date);
        const tooltip = `Calculated based on ${monthsWorked} months (from ${fromMonth} to ${toMonth})`;

        rows += `
          <tr>
            <td>${emp.name}</td>
            <td>${emp.join_date}</td>
            <td>${emp.outlet}</td>
            <td>${formatNumber(emp.total_sales)}</td>
            <td title="${tooltip}">${formatNumber(avg)}</td>
            <td>${formatNumber(emp.salary)}</td>
            <td>${emp.years_of_service}</td>
            <td>${formatNumber(emp.commissions)}</td>
            <td>${formatNumber(emp.average_income)}</td>
          </tr>`;
      });

      if (!rows.trim()) return;

      managerHTML += `
        <div class='bg-white shadow-md rounded-lg p-4 mb-8'>
          <div class='flex justify-between items-center mb-3'>
            <h3 class='text-lg font-bold text-gray-800'>${storeData.original_name}</h3>
          </div>
          <div class='overflow-x-auto'>
            <table class='w-full text-sm text-gray-700'>
              <thead>
                <tr>
                  <th data-key='name'>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th data-key='join_date'>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th>
                  <th data-key='outlet'>Ø§Ù„Ù…Ø¹Ø±Ø¶</th>
                  <th data-key='total_sales'>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                  <th data-key='avg_sales'>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</th>
                  <th data-key='salary'>Ø§Ù„Ø±Ø§ØªØ¨</th>
                  <th data-key='years_of_service'>Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                  <th data-key='commissions'>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</th>
                  <th data-key='average_income'>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>`;
    });

    container.innerHTML += managerHTML;
  }

  document.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.dataset.key;
      const table = th.closest('table');
      sortTable(table, key);
    });
  });
}


    function calculateAvgSales(totalSales, joinDateStr) {
      if (!totalSales) return { avg: 0, monthsWorked: 0, fromMonth: "-", toMonth: "-" };
      try {
        const totalMonths = 9; // Jan to Sep 2025
        const joinDate = new Date(joinDateStr);
        if (isNaN(joinDate)) return { avg: totalSales / totalMonths, monthsWorked: 9, fromMonth: "January", toMonth: "September" };

        const startOfYear = new Date('2025-01-01');
        const endOfData = new Date('2025-09-30');
        let effectiveStart = joinDate > startOfYear ? joinDate : startOfYear;

        let monthsWorked =
          (endOfData.getFullYear() - effectiveStart.getFullYear()) * 12 +
          (endOfData.getMonth() - effectiveStart.getMonth()) + 1;

        if (monthsWorked < 1) monthsWorked = 1;
        if (monthsWorked > 9) monthsWorked = 9;

        const fromMonth = effectiveStart.toLocaleString('en-US', { month: 'long' });
        const toMonth = endOfData.toLocaleString('en-US', { month: 'long' });

        return {
          avg: totalSales / monthsWorked,
          monthsWorked,
          fromMonth,
          toMonth
        };
      } catch {
        return { avg: totalSales / 9, monthsWorked: 9, fromMonth: "January", toMonth: "September" };
      }
    }

    function sortTable(table, key) {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const headerIndex = Array.from(table.querySelectorAll('th')).findIndex(th => th.dataset.key === key);
      const isNumeric = ['total_sales', 'avg_sales', 'salary', 'commissions', 'average_income'].includes(key);

      let direction = 'asc';
      if (table.dataset.sorted === key && table.dataset.direction === 'asc') direction = 'desc';
      else if (table.dataset.sorted === key && table.dataset.direction === 'desc') {
        table.dataset.sorted = '';
        table.dataset.direction = '';
        rows.sort((a, b) => 0);
        tbody.innerHTML = '';
        rows.forEach(r => tbody.appendChild(r));
        return;
      }

      table.dataset.sorted = key;
      table.dataset.direction = direction;

      rows.sort((a, b) => {
        const valA = a.children[headerIndex].textContent.trim().replace(/,/g, '');
        const valB = a.children[headerIndex].textContent.trim().replace(/,/g, '');
        const numA = parseFloat(valA) || 0;
        const numB = parseFloat(valB) || 0;
        if (isNumeric) return direction === 'asc' ? numA - numB : numB - numA;
        return direction === 'asc' ? valA.localeCompare(valB, 'ar') : valB.localeCompare(valA, 'ar');
      });

      tbody.innerHTML = '';
      rows.forEach(r => tbody.appendChild(r));
    }

    function formatNumber(num) {
      const n = parseFloat(num) || 0;
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);
    }

    function normalizeName(name) {
      if (!name) return '';
      return name.toLowerCase().trim().replace(/[-_]/g, ' ').replace(/\s+/g, ' ');
    }

    document.addEventListener('DOMContentLoaded', initializeDashboard);
  </script>
</body>
</html>
