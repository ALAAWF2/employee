# -*- coding: utf-8 -*-
"""
converter_employees_v2_clean.py
Ø¥Ø¹Ø¯Ø§Ø¯: Ø¹Ù„Ø§Ø¡ ÙˆÙØ§Ø¦ÙŠ ğŸŸ§
Ø§Ù„ØºØ±Ø¶: ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„ÙØ±ÙˆØ¹ Ø¥Ù„Ù‰ Ù…Ù„Ù JSON Ù…ØªÙƒØ§Ù…Ù„
        Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚ÙŠÙ… ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø© (NaN, None, inf) ÙˆØ¶Ù…Ø§Ù† ØµÙŠØ§ØºØ© ÙˆØ§Ù‚Ø¹ÙŠØ© Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø©.
"""

import pandas as pd
import json
import numpy as np
from datetime import datetime

# ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª =====
EMP_FILE = "emp.csv"
BRANCHES_FILE = "branches.csv"
OUTPUT_FILE = "data.json"
ENCODING = "windows-1256"

# =====================================================
def normalize_name(name: str):
    """ØªÙˆØ­ÙŠØ¯ Ø´ÙƒÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø©"""
    if not isinstance(name, str):
        return ""
    return (
        name.strip()
        .lower()
        .replace("_", " ")
        .replace("-", " ")
        .replace("\\", " ")
        .replace("/", " ")
        .replace("  ", " ")
    )

# =====================================================
def calculate_years_of_service(join_date_str: str):
    """ØªØ­Ø³Ø¨ Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨ØµÙŠØºØ© Ù…Ø«Ù„ '5 Ùˆ 6 Ø´Ù‡ÙˆØ±'"""
    try:
        join_date = pd.to_datetime(join_date_str, errors="coerce")
        if pd.isna(join_date):
            return "0"
        today = pd.Timestamp.today()
        diff = today - join_date
        years = diff.days // 365
        months = (diff.days % 365) // 30

        if years == 0 and months == 0:
            return "Ø£Ù‚Ù„ Ù…Ù† Ø´Ù‡Ø±"
        if years == 0:
            return f"{months} Ø´Ù‡ÙˆØ±"
        if months == 0:
            return f"{years}"
        return f"{years} Ùˆ {months} Ø´Ù‡ÙˆØ±"
    except Exception:
        return "0"

# =====================================================
def safe_float(value):
    """ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø¨Ø£Ù…Ø§Ù† Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù…ÙˆØ² ÙˆØ§Ù„ÙÙˆØ§ØµÙ„"""
    try:
        if value in [None, "", "nan", "NaN", "None"]:
            return 0.0
        value = str(value).replace(",", "").replace("Ù«", ".").strip()
        return float(value)
    except:
        return 0.0

# =====================================================
def clean_data(obj):
    """ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚ÙŠÙ… ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø© Ø¯Ø§Ø®Ù„ dict Ø£Ùˆ list ÙÙŠ Ø£ÙŠ Ø¹Ù…Ù‚"""
    if isinstance(obj, dict):
        return {k: clean_data(v) for k, v in obj.items()}
    elif isinstance(obj, list):
        return [clean_data(v) for v in obj]
    elif isinstance(obj, float):
        if np.isnan(obj) or np.isinf(obj):
            return 0
        return obj
    elif obj in [None, "NaN", "nan", "None"]:
        return 0
    return obj

# =====================================================
def process():
    try:
        print("ğŸ“¥ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„ÙØ§Øª CSV...")
        emp_df = pd.read_csv(EMP_FILE, encoding=ENCODING)
        branches_df = pd.read_csv(BRANCHES_FILE, encoding=ENCODING)

        emp_df.columns = emp_df.columns.str.strip()
        branches_df.columns = branches_df.columns.str.strip()

        # ===== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ =====
        print("ğŸ§­ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡...")
        managers_map = {}
        for _, row in branches_df.iterrows():
            manager = str(row.get("AREA MANAGER", "")).strip()
            branch = str(row.get("BRANCH", "")).strip()
            if not manager or not branch:
                continue
            managers_map.setdefault(manager, []).append(branch)

        # ===== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† =====
        print("ğŸ‘· Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...")
        employees_by_store = {}
        total_employees = 0

        for _, row in emp_df.iterrows():
            outlet_raw = str(row.get("outlet name", "")).strip()
            if not outlet_raw:
                continue

            normalized_outlet = normalize_name(outlet_raw)
            if normalized_outlet not in employees_by_store:
                employees_by_store[normalized_outlet] = {
                    "original_name": outlet_raw,
                    "employees": []
                }

            emp_id = row.get("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ", "")
            name = str(row.get("name", "")).strip()
            title = str(row.get("Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ", "")).strip()
            join_date = str(row.get("join date", "")).strip()
            years_of_service = calculate_years_of_service(join_date)
            sales = safe_float(row.get("sales", 0))
            salary = safe_float(row.get("salary", 0))
            commissions = safe_float(row.get("Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª", 0))
            avg_income = salary + commissions

            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±Ø¶
            manager_name = ""
            for m_name, stores in managers_map.items():
                if outlet_raw in stores:
                    manager_name = m_name
                    break

            employees_by_store[normalized_outlet]["employees"].append({
                "id": emp_id,
                "name": name,
                "title": title,
                "outlet": outlet_raw,
                "manager": manager_name,
                "join_date": join_date,
                "years_of_service": years_of_service,
                "salary": salary,
                "commissions": commissions,
                "total_sales": sales,
                "average_income": avg_income
            })
            total_employees += 1

        final_data = {
            "managers": managers_map,
            "employees_by_store": employees_by_store
        }

        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚ÙŠÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
        final_data = clean_data(final_data)

        # ===== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
        print("ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSON...")
        with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
            json.dump(final_data, f, ensure_ascii=False, indent=4)

        print(f"\nâœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù '{OUTPUT_FILE}' Ø¨Ù†Ø¬Ø§Ø­!")
        print(f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠ: {total_employees}")
        print(f"ğŸ¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶: {len(employees_by_store)}")

    except FileNotFoundError as e:
        print(f"âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: {e.filename}")
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")

# =====================================================
if __name__ == "__main__":
    process()
